---
- name: Get the installed Matomo version number
  shell: "php console core:update --no-ansi -n --version | awk '{ print $3 }'"
  args:
    executable: /bin/bash
    chdir: "{{ matomo_html }}"
  changed_when: false
  check_mode: false
  become: true
  become_user: "{{ matomo_user }}"
  register: matomo_installed_check
  tags:
    - matomo

- name: Set a variable for the installed Matomo version number
  set_fact:
    matomo_installed: "{{ matomo_installed_check.stdout }}"
  tags:
    - matomo

- name: Print the installed version of Matomo
  debug:
    msg: "The installed version of Matomo is {{ matomo_installed }}"
    verbosity: 1
  tags:
    - matomo

- name: Check if Extra Tools is activated
  shell: "php console --no-ansi plugin:activate ExtraTools || echo FAIL"
  args:
    executable: /bin/bash
    chdir: "{{ matomo_html }}"
  check_mode: false
  become: true
  become_user: "{{ matomo_user }}"
  register: matomo_extratools_check
  changed_when: '"ExtraTools is already activated" not in matomo_extratools_check.stdout'
  tags:
    - matomo

- name: Variable set for Extra Tools install
  set_fact:
    matomo_extratools: install
  when: '"FAIL" in matomo_extratools_check.stdout'
  tags:
    - matomo

- name: Check if User Console is activated
  shell: "php console --no-ansi plugin:activate UserConsole || echo FAIL"
  args:
    executable: /bin/bash
    chdir: "{{ matomo_html }}"
  check_mode: false
  become: true
  become_user: "{{ matomo_user }}"
  register: matomo_userconsole_check
  changed_when: '"UserConsole is already activated" not in matomo_userconsole_check.stdout'
  tags:
    - matomo

- name: Variable set for User Console install
  set_fact:
    matomo_userconsole: install
  when: '"FAIL" in matomo_userconsole_check.stdout'
  tags:
    - matomo
...
