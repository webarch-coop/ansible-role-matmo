---
# https://github.com/Aversiste/ansible-matomo/blob/master/tasks/main.yml

- name: Step 1 Welcome
  uri:
    url: "{{ matomo_url }}index.php?action=welcome"
    method: GET
    status_code: 200
  register: matomo_welcome

- name: Debug Welcome Cookies
  debug:
    var: matomo_welcome.cookies
    verbosity: 2

- name: Set a variable for the MATOMO_SESSID cookie
  set_fact:
    matomo_session_cookie: "MATOMO_SESSID={{ cookie.value }}" 
  when: cookie.key == "MATOMO_SESSID"
  loop: "{{ matomo_welcome.cookies | dict2items }}"
  loop_control:
    loop_var: cookie

- name: Pause
  pause:
    seconds: 1

- name: Step 2 System Check
  uri:
    url: "{{ matomo_url }}index.php?action=systemCheck"
    method: GET
    headers:
      Cookie: "{{ matomo_session_cookie }}"
    status_code: 200

- name: Pause
  pause:
    seconds: 1

- name: Step 3 Database Set-up
  uri:
    url: "{{ matomo_url }}index.php?action=databaseSetup"
    method: POST
    headers:
      Cookie: "{{ matomo_session_cookie }}"
    body:
      host: "{{ matomo_db_host }}"
      username: "{{ matomo_db_username }}"
      password: "{{ matomo_db_pass }}"
      dbname: "{{ matomo_dbname }}"
      tables_prefix: "{{ matomo_db_prefix | default('matomo_') }}"
      adapter: "{{ matomo_db_adaptor | default('PDO\\MYSQL') }}"
    body_format: form-urlencoded
    status_code: 302

- name: Pause
  pause:
    seconds: 1

- name: Step 4 Table Creation
  uri:
    url: "{{ matomo_url }}index.php?action=tablesCreation&module=Installation"
    method: GET
    status_code: 200

- name: Pause
  pause:
    seconds: 1

- name: Step 5 General Set-up
  uri:
    url: "{{ matomo_url }}index.php?action=setupSuperUser&module=Installation"
    method: POST
    headers:
      Cookie: "{{ matomo_session_cookie }}"
    body:
      login: "{{ matomo_first_user }}"
      password: "{{ matomo_first_user_pass }}"
      password_bis: "{{ matomo_first_user_pass }}"
      email: "{{ matomo_first_user_email }}"
      subscribe_newsletter_piwikorg: 0
      subscribe_newsletter_professionalservices: 0
    body_format: form-urlencoded
    status_code: 302

- name: Pause
  pause:
    seconds: 1

- name: Step 6 Configure first web-site
  uri:
    url: "{{ matomo_url }}index.php?action=firstWebsiteSetup&module=Installation"
    method: POST
    headers:
      Cookie: "{{ matomo_session_cookie }}"
    body:
      siteName: "{{ matomo_first_site_name }}"
      url: "{{ matomo_first_site_url }}"
      timezone: "{{ matomo_first_site_tz | default('Europe/London') }}"
      ecommerce: 0
    body_format: form-urlencoded
    status_code: 302

- name: Pause
  pause:
    seconds: 1

- name: Step 7 Display JavaScript tracking code
  uri:
    url: "{{ matomo_url }}index.php?action=trackingCode&module=Installation&site_idSite=1&site_name=example.org"
    method: GET
    headers:
      Cookie: "{{ matomo_session_cookie }}"
    status_code: 200

- name: Pause
  pause:
    seconds: 1

- name: Step 8 Finished!
  uri:
    url: "{{ matomo_url }}index.php?action=finished&module=Installation"
    method: POST
    headers:
      Cookie: "{{ matomo_session_cookie }}"
    body:
      do_not_track: 1
      anonymise_ip: 1
      submit: "Continue to Matomo Â»"
    body_format: form-urlencoded
    status_code: 302
...
