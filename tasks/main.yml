---
- name: Include variables checks
  include_tasks: check_variables.yml
  tags:
    - matomo

- name: Check that required variables are defined
  assert:
    that:
      - ( matomo_user is defined ) and ( matomo_user is regex("^[a-z0-9]*$") ) 
      - ( matomo_db_username is defined ) and ( ) 
      - ( matomo_db_host is defined ) and ( ) 
      - ( matomo_dbname is defined ) and ( ) 
      - ( matomo_url is defined ) and ( ) 
      - ( matomo_first_site_name is defined ) and ( ) 
      - ( matomo_first_site_url is defined ) and ( ) 
      - ( matomo_first_user is defined ) and ( ) 
      - ( matomo_first_user_email is defined ) and ( ) 
      - ( matomo_notify_passwd is defined ) and ( ) 
      - ( matomo_notify_from is defined ) and ( ) 
      - ( matomo_notify_reply_to is defined ) and ( ) 
      - ( matomo_notify_headers is defined ) and ( ) 
      - ( matomo_notify_subject_tag is defined ) and ( ) 
      - ( matomo_notify_passwd_signature is defined ) and ( ) 
      - ( matomo_git is defined ) and ( ) 
  tags:
    - matomo

- name: Only install or upgrade Matomo if the user account exists
  block:

    - name: Required directories present
      file:
        path: "{{ matomo_home }}/{{ dir }}"
        state: directory
        owner: "{{ matomo_user }}"
        group: "{{ matomo_user }}"
        mode: 0700
      loop:
        - .ansible
        - .gnupg
      loop_control:
        loop_var: dir
      tags:
        - matomo

    # https://builds.piwik.org/signature.asc
    - name: The Matomo GPG public key is present
      copy:
        src: files/matomo.pub
        dest: "{{ matomo_private }}/matomo.pub"
      become: true
      become_user: "{{ matomo_user }}"
      tags:
        - matomo

    - name: The Matomo GPG public key is imported
      command: "gpg --no-tty --import {{ matomo_private }}/matomo.pub"
      register: matomo_gpg_key_import
      changed_when: "'not changed' not in matomo_gpg_key_import.stderr"
      become: true
      become_user: "{{ matomo_user }}"
      tags:
        - matomo

    # https://github.com/web-flow.gpg
    - name: The GitHub GPG public key is present
      copy:
        src: files/github.pub
        dest: "{{ matomo_private }}/github.pub"
      become: true
      become_user: "{{ matomo_user }}"
      tags:
        - matomo

    - name: The GitHub GPG public key is imported
      command: "gpg --no-tty --import {{ matomo_private }}/github.pub"
      register: matomo_gh_gpg_key_import
      changed_when: "'not changed' not in matomo_gh_gpg_key_import.stderr"
      become: true
      become_user: "{{ matomo_user }}"
      tags:
        - matomo

    - name: Include latest version check
      include_tasks: check_latest_version.yml
      tags:
        - matomo

    - name: Check for config.ini.php
      stat:
        path: "{{ matomo_html }}/config/config.ini.php"
      register: matomo_config_check
      tags:
        - matomo

    - name: Check the Matomo version and then conditionally upgrade
      block:

        - name: Include version check
          include_tasks: check_version.yml
          tags:
            - matomo

        - name: Include upgrade tasks
          include_tasks: upgrade.yml
          when: matomo_installed != matomo_latest
          tags:
            - matomo

        - name: Include version check
          include_tasks: check_version.yml
          tags:
            - matomo

      when: ( matomo_config_check is defined ) and ( matomo_config_check.stat.exists == True )

    - name: Include install tasks
      include_tasks: install.yml
      when: ( matomo_config_check is defined ) and ( matomo_config_check.stat.exists == False )
      tags:
        - matomo

    - name: Include Extra Tools tasks
      include_tasks: extratools.yml
      when: ( matomo_extratools is defined ) and ( matomo_extratools == "force" )
      tags:
        - matomo

    - name: Include User Console tasks
      include_tasks: userconsole.yml
      when: ( matomo_userconsole is defined ) and ( matomo_userconsole == "force" )
      tags:
        - matomo

    - name: Include cron tasks
      include_tasks: cron.yml
      tags:
        - matomo

  when: '"no such user" not in matomo_user_check.stderr'
...
