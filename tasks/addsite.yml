---
- name: Add Matomo site
  block:

    - name: Print the matomo_site_name and matomo_site_main_url variables
      debug:
        msg:
          - "The matomo_site_name variable contains: {{ matomo_site_name }}"
          - "The matomo_site_main_url variable contains: {{ matomo_site_main_url }}"
        verbosity: 1

    - name: Print the matomo_site_urls if defined
      debug:
        msg: "The matomo_site_urls array contains: {{ matomo_site_urls }}"
        verbosity: 1
      when: ( matomo_site_urls is defined ) and ( matomo_site_urls != [] )

    - name: Check that the variables needed are set
      assert:
        that:
          - matomo_site_name is defined
          - matomo_site_main_url is defined

    - name: Check the sites and populate the matomo_sites_names array
      include_tasks: list_sites.yml

    - name: "Add {{ matomo_site_name }} to the Matomo server"
      block:

        - name: Set matomo_urls for the console site:add command
          set_fact:
            matomo_urls: "{{ matomo_site_main_url }}{% for u in matomo_site_urls %}, {{ u }}{% endfor %}"

        - name: Print the matomo_urls
          debug:
            msg: "matomo_urls: '{{ matomo_urls }}'"
            verbosity: 1
          tags:
            - matomo
            - users-update

        - name: Add Matomo site using the API
          uri:
            url: "{{ matomo_url }}"
            method: POST
            body_format: form-urlencoded
            body:
              module: API
              format: JSON
              token_auth: "{{ matomo_token_auth }}"
              method: SitesManager.addSite
              siteName: "{{ matomo_site_name }}"
              urls: "{{ matomo_urls }}"
          register: matomo_api_add_site
          changed_when: not matomo_api_add_site.failed

        - name: Debug matomo_api_add_site
          debug:
            var: matomo_api_add_site
            verbosity: 2

        - name: Set the matomo_idsite variable
          set_fact:
            matomo_idsite: "{{ matomo_api_add_site.json.value }}"
          when:
            - ( not matomo_api_add_site.failed )

      when: matomo_site_name not in matomo_sites_names

    - name: Include the idsite tasks, this sets matomo_idsite
      include_tasks: idsite.yml

    - name: "Conditionally check and add the {{ matomo_site_name }} site_urls"
      include_tasks: addurls.yml
      when:
        - ( matomo_site_urls is defined ) and ( matomo_site_urls | length > 0 )
        - ( matomo_idsite is defined ) and ( matomo_idsite | length > 0 )

    - name: "Check if {{ matomo_site_admin }} is a super user using the API"
      uri:
        url: "{{ matomo_url }}"
        method: POST
        body_format: form-urlencoded
        body:
          module: API
          format: JSON
          token_auth: "{{ matomo_token_auth }}"
          method: UsersManager.hasSuperUserAccess
      register: matomo_api_has_super_user_access

    - name: Debug matomo_api_has_super_user_access
      debug:
        var: matomo_api_has_super_user_access
        verbosity: 2

    - name: "Grant admin access for {{ matomo_site_admin }} to {{ matomo_site_name }} using the API"
      uri:
        url: "{{ matomo_url }}"
        method: POST
        body_format: form-urlencoded
        body:
          module: API
          format: JSON
          token_auth: "{{ matomo_token_auth }}"
          method: UsersManager.setUserAccess
          userLogin: "{{ matomo_site_admin }}"
          access: admin
          idSites: "{{ matomo_idsite }}"
      register: matomo_api_set_user_access
      when:
        - ( matomo_site_admin is defined ) and ( matomo_site_admin | length > 0 )
        - ( matomo_idsite is defined ) and ( matomo_idsite | length > 0 )
        - ( not matomo_api_has_super_user_access.json.value )

    - name: Debug matomo_api_set_user_access
      debug:
        var: matomo_api_set_user_access
        verbosity: 2

  tags:
    - matomo
...
