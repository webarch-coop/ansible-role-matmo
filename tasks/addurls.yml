---
- name: Add URLs to Matomo site
  block:

    - name: Set matomo_idsite_urls to an empty array
      set_fact:
        matomo_idsite_urls: []

    - name: "Get the URLs for the {{ matomo_site_name }} site using the API"
      uri:
        url: "{{ matomo_url }}"
        method: POST
        body_format: form-urlencoded
        body:
          module: API
          format: JSON
          token_auth: "{{ matomo_token_auth }}"
          method: SitesManager.getSiteUrlsFromId
          idSite: "{{ matomo_idsite }}"
      register: matomo_api_get_site_urls_from_id

    - name: Debug matomo_api_get_site_urls_from_id
      debug:
        var: matomo_api_get_site_urls_from_id
        verbosity: 2

    - name: Print the Matomo existing site URLs
      debug:
        msg: "Matomo site url's: {{ matomo_api_get_site_urls_from_id.json }}"
        verbosity: 1

    - name: Get the difference between the matomo_site_urls and the Apache Aliases
      set_fact:
        matomo_missing_urls: "{{ matomo_site_urls | difference(matomo_api_get_site_urls_from_id.json) }}"

    - name: "Print the missing URLs for site ID: {{ matomo_idsite }}"
      debug:
        msg: "matomo_missing_urls: {{ matomo_missing_urls }}"
        verbosity: 1

    - name: Add missing URLs 
      uri:
        url: "{{ matomo_url }}"
        method: POST
        body_format: form-urlencoded
        body:
          module: API 
          format: JSON
          token_auth: "{{ matomo_token_auth }}"
          method: SitesManager.addSiteAliasUrls
          idSite: "{{ matomo_idsite }}"
          urls: "{{ matomo_missing_urls }}"
      register: matomo_api_add_site_alias_urls

    - name: Debug matomo_api_add_site_alias_urls
      debug:
        var: matomo_api_add_site_alias_urls
        verbosity: 2

  tags:
    - matomo
...
